<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Schiffeversenken Modern Pixel</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --cyan:#6ee7ff;
      --blue:#2ca4ff;
      --deep:#071325;
      --panel:#0d1f37cc;
      --line:#3e6ca8;
    }
    body {
      font-family: Inter, Segoe UI, Arial, sans-serif;
      background:
        radial-gradient(circle at 18% 15%, #103b77 0, transparent 32%),
        radial-gradient(circle at 85% 10%, #3b1a7a 0, transparent 28%),
        linear-gradient(180deg, #050d1a 0%, #071325 55%, #03070f 100%);
      color: #e9f3ff;
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 16px;
      overflow-x: hidden;
    }
    .bg-grid {
      position: fixed; inset: 0; pointer-events: none; opacity: .22;
      background-image:
        linear-gradient(rgba(99,180,255,.22) 1px, transparent 1px),
        linear-gradient(90deg, rgba(99,180,255,.2) 1px, transparent 1px);
      background-size: 42px 42px;
      mask-image: radial-gradient(circle at 50% 45%, #000 35%, transparent 90%);
    }
    .vignette {
      position: fixed; inset: 0; pointer-events: none;
      background: radial-gradient(circle at center, transparent 35%, rgba(0,0,0,.6) 100%);
    }
    .game {
      position: relative;
      width: min(1250px, 100%);
      background: linear-gradient(180deg, rgba(11,26,46,.92), rgba(7,18,34,.92));
      border: 1px solid #3f74b9;
      border-radius: 18px;
      padding: 18px;
      box-shadow: 0 20px 60px rgba(0,0,0,.45), 0 0 35px rgba(80,170,255,.15);
      backdrop-filter: blur(8px);
    }
    h1 {
      text-align: center;
      margin-bottom: 14px;
      color: #9ddfff;
      letter-spacing: .5px;
      text-shadow: 0 0 14px rgba(110,231,255,.35);
    }
    .setup, .status { margin-bottom: 14px; text-align: center; }
    .status {
      border: 1px solid #2f5d95;
      background: rgba(10,30,56,.6);
      border-radius: 10px;
      padding: 10px;
      box-shadow: inset 0 0 10px rgba(62,131,204,.15);
    }
    .row { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin: 10px 0; }
    button {
      background: linear-gradient(135deg, #13b5ff, #5569ff 55%, #8a4dff);
      color: #fff;
      border: 1px solid rgba(184,232,255,.5);
      border-radius: 11px;
      padding: 10px 14px;
      font-weight: 800;
      cursor: pointer;
      box-shadow: 0 6px 18px rgba(0,0,0,.35);
      transition: transform .16s ease, box-shadow .16s ease, filter .16s ease;
    }
    button:hover {
      transform: translateY(-1px) scale(1.02);
      box-shadow: 0 10px 24px rgba(52,127,255,.35);
      filter: saturate(1.08);
    }
    button:disabled { opacity: .45; cursor: not-allowed; transform:none; }
    .boards { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .panel {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px;
      box-shadow: inset 0 0 16px rgba(82,146,224,.08);
    }
    .panel h3 { text-align: center; margin-bottom: 8px; color: #a8deff; }
    .board {
      display: grid;
      grid-template-columns: repeat(11, 34px);
      grid-template-rows: repeat(11, 34px);
      gap: 2px;
      justify-content: center;
      user-select: none;
      touch-action: manipulation;
    }
    .cell {
      position: relative;
      border: 1px solid #3568a0;
      background:
        linear-gradient(180deg, #0e4f8f, #0a3a6b),
        repeating-linear-gradient(45deg, rgba(255,255,255,.04) 0 2px, transparent 2px 6px);
      display: grid;
      place-items: center;
      color: #cbe9ff;
      overflow: hidden;
    }
    .header { background: linear-gradient(180deg, #1a4a86, #12345f); font-size: 12px; font-weight: 800; }
    .clickable:hover { filter: brightness(1.22) saturate(1.1); cursor: crosshair; }

    .ship-cell {
      background-size: cover;
      background-position: center;
      image-rendering: pixelated;
    }
    .ship-hidden { background-image: none !important; }

    .hit { background: linear-gradient(180deg,#8e1e1e,#5d1010) !important; box-shadow: inset 0 0 10px rgba(255,128,64,.4); }
    .miss { background: linear-gradient(180deg,#1779a5,#115679) !important; }
    .sunk { outline: 2px solid #ff8f36; box-shadow: 0 0 12px rgba(255,143,54,.45); }

    .anim {
      position: absolute; width: 28px; height: 28px; pointer-events: none; image-rendering: pixelated;
      animation: pop .42s ease-out forwards;
    }
    .anim.hitfx { background: radial-gradient(circle, #fff 0 14%, #ffe17a 15% 35%, #ff7137 36% 62%, #8f1d00 63% 100%); }
    .anim.missfx { background: radial-gradient(circle, #d3f2ff 0 18%, #8ee7ff 19% 42%, #1fa5cf 43% 100%); }
    @keyframes pop {
      0% { transform: scale(.2); opacity: 0; }
      45% { transform: scale(1.35); opacity: 1; }
      100% { transform: scale(1); opacity: 0; }
    }

    .ship-list { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; margin: 8px 0; }
    .ship-item {
      padding: 8px 10px;
      border: 1px solid #4f80bc;
      border-radius: 8px;
      background: linear-gradient(180deg,#123055,#0f2745);
      cursor: pointer;
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .ship-item:hover { transform: translateY(-1px); box-shadow: 0 6px 12px rgba(0,0,0,.25); }
    .ship-item.sel { outline: 2px solid #89d5ff; box-shadow: 0 0 10px rgba(137,213,255,.35); }
    .ship-item.done { background: linear-gradient(180deg,#17875f,#146c4d); border-color: #2fbf8a; }

    .small { font-size: 13px; opacity: .95; }
    .popup {
      position: fixed;
      left: 50%;
      top: 24px;
      transform: translateX(-50%) translateY(-20px);
      background: linear-gradient(135deg, rgba(20,40,72,.95), rgba(16,84,128,.95));
      border: 1px solid #77d9ff;
      border-radius: 12px;
      padding: 12px 18px;
      font-weight: 800;
      letter-spacing: .3px;
      box-shadow: 0 12px 30px rgba(0,0,0,.4);
      opacity: 0;
      pointer-events: none;
      z-index: 9999;
      transition: all .25s ease;
      color: #e9f8ff;
    }
    .popup.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    .popup.hit { border-color:#ffd96a; }
    .popup.sunk { border-color:#ff9e57; }
    .popup.win { border-color:#6dffad; }
    .popup.lose { border-color:#ff7f8c; }
    .rules {
      margin: 12px auto 0;
      max-width: 880px;
      text-align: left;
      background: rgba(9, 27, 49, .65);
      border: 1px solid #335f95;
      border-radius: 10px;
      padding: 12px 14px;
      line-height: 1.45;
      font-size: 13px;
    }
    .rules b { color: #9fdcff; }
    .hide { display: none !important; }

    @media (max-width: 980px) {
      .boards { grid-template-columns: 1fr; }
      .board { grid-template-columns: repeat(11, 30px); grid-template-rows: repeat(11, 30px); }
    }
    @media (max-width: 640px) {
      body { padding: 8px; }
      .game { padding: 10px; border-radius: 12px; }
      h1 { font-size: 1.25rem; margin-bottom: 8px; }
      .panel { padding: 6px; }
      .board { grid-template-columns: repeat(11, 25px); grid-template-rows: repeat(11, 25px); gap: 1px; }
      .cell { font-size: 11px; }
      .row { gap: 6px; margin: 6px 0; }
      button { padding: 8px 10px; font-size: 13px; border-radius: 8px; }
      .rules { font-size: 12px; padding: 8px 10px; }
      .popup { top: 8px; width: calc(100% - 16px); left: 8px; transform: translateY(-20px); padding: 10px 12px; }
      .popup.show { transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div class="bg-grid"></div>
  <div class="vignette"></div>
  <div id="popup" class="popup"></div>
  <div class="game">
    <h1>‚öì Schiffeversenken ‚Äî Modern Pixel</h1>
    <div class="small" style="text-align:center; margin-top:-8px; margin-bottom:10px; opacity:.85;">Neon-Navy UI ‚Ä¢ inspiriert von modernen Arcade-/Indie-Webgame-Styles</div>

    <div id="setup" class="setup">
      <div class="row">
        <button onclick="setMode('ai')">Solo vs KI</button>
        <button onclick="setMode('pvp')">1 vs 1 (Hotseat)</button>
      </div>
      <div class="row" id="difficultyRow">
        <button onclick="startNew('leicht')">Leicht</button>
        <button onclick="startNew('mittel')">Mittel</button>
        <button onclick="startNew('schwer')">Schwer</button>
      </div>
      <div class="small">Pixel-Sprites + Animationen + Soundeffekte aktiv. R = Schiff drehen.</div>
      <div class="row" style="margin-top:8px;">
        <button onclick="setFxLevel('low')">FX niedrig</button>
        <button onclick="setFxLevel('normal')">FX normal</button>
        <button onclick="setFxLevel('high')">FX hoch</button>
        <button id="musicToggle" onclick="toggleMusic()">Musik: Aus</button>
      </div>
      <div class="row hide" id="postGameRow">
        <button onclick="goToStart()">‚Ü©Ô∏è Zum Startbildschirm</button>
      </div>
      <div class="rules">
        <b>Spielregeln:</b><br>
        ‚Ä¢ 10√ó10 Feld, 5 Schiffe pro Seite (5/4/3/3/2).<br>
        ‚Ä¢ Schiffe nur horizontal oder vertikal.<br>
        ‚Ä¢ Schiffe d√ºrfen sich <b>nicht ber√ºhren</b> (auch nicht diagonal).<br>
        ‚Ä¢ Pro Zug ein Schuss. Ergebnis: Wasser / Treffer / Versenkt.<br>
        ‚Ä¢ Wer alle gegnerischen Schiffe versenkt, gewinnt.<br>
        ‚Ä¢ Diese Regeln gelten f√ºr Spieler <b>und</b> KI gleicherma√üen.
      </div>
    </div>

    <div id="placement" class="hide">
      <div class="status" id="placementTitle"></div>
      <div class="ship-list" id="shipList"></div>
      <div class="row">
        <button onclick="toggleOrientation()">Drehen ‚Üª</button>
        <button onclick="randomPlacement()">Zuf√§llig platzieren</button>
        <button onclick="finishPlacement()" id="btnPlacementDone" disabled>Platzierung fertig</button>
      </div>
      <div class="small" style="text-align:center">W√§hle Schiff ‚Üí tippe Feld. Taste R oder Button ‚ÄûDrehen‚Äú wechselt Horizontal/Vertikal.</div>
    </div>

    <div id="status" class="status hide"></div>

    <div class="boards hide" id="boards">
      <div class="panel">
        <h3 id="titleLeft">Spieler 1</h3>
        <div class="board" id="boardLeft"></div>
      </div>
      <div class="panel">
        <h3 id="titleRight">Gegner</h3>
        <div class="board" id="boardRight"></div>
      </div>
    </div>
  </div>

  <audio id="sfx-hit" src="assets/audio/hit.ogg" preload="auto"></audio>
  <audio id="sfx-miss" src="assets/audio/miss.ogg" preload="auto"></audio>
  <audio id="sfx-sunk" src="assets/audio/sunk.ogg" preload="auto"></audio>
  <audio id="sfx-win" src="assets/audio/win.ogg" preload="auto"></audio>
  <audio id="sfx-lose" src="assets/audio/lose.ogg" preload="auto"></audio>
  <audio id="bg-menu" src="assets/audio/menu.ogg" preload="auto" loop></audio>

  <script>
    const N = 10;
    const SHIPS = [
      { id:'carrier', name:'Flugzeugtr√§ger', size:5, hue:200 },
      { id:'battleship', name:'Schlachtschiff', size:4, hue:170 },
      { id:'cruiser', name:'Kreuzer', size:3, hue:145 },
      { id:'submarine', name:'U-Boot', size:3, hue:120 },
      { id:'destroyer', name:'Zerst√∂rer', size:2, hue:95 }
    ];

    let mode = 'ai';
    let difficulty = 'mittel';
    let phase = 'setup'; // setup, placement, battle, over
    let placementPlayer = 1;
    let currentPlayer = 1; // turn owner in battle
    let selShip = null;
    let horizontal = true;
    let aiTargets = [];

    const state = {
      p1: makePlayer('Spieler 1'),
      p2: makePlayer('Spieler 2'),
      ai: makePlayer('KI')
    };

    const sprites = {};
    let actx;
    let fxLevel = 'normal';
    let musicOn = false;

    function makePlayer(name){
      return { name, board:emptyBoard(), ships:{}, shots:new Set(), hits:0, totalShots:0 };
    }
    function emptyBoard(){ return Array.from({length:N},()=>Array.from({length:N},()=>({ ship:null, hit:false, miss:false }))); }
    const key=(r,c)=>`${r},${c}`;

    function setMode(m){
      mode = m;
      document.getElementById('difficultyRow').classList.toggle('hide', m==='pvp');
      setStatus(m==='pvp' ? 'Modus: 1 vs 1 Hotseat gew√§hlt.' : 'Modus: Solo vs KI gew√§hlt.');
    }

    function setFxLevel(level='normal'){
      fxLevel = level;
      showPopup(`FX-Level: ${level.toUpperCase()}`, 'hit', 900);
    }

    function ensureAudio(){
      if(!actx) actx = new (window.AudioContext||window.webkitAudioContext)();
      if(actx.state === 'suspended') actx.resume();
    }

    function toggleMusic(){
      ensureAudio();
      musicOn = !musicOn;
      const btn = document.getElementById('musicToggle');
      const menu = document.getElementById('bg-menu');
      if(btn) btn.textContent = `Musik: ${musicOn ? 'An' : 'Aus'}`;
      if(!menu) return;
      menu.volume = fxLevel === 'low' ? 0.18 : (fxLevel === 'high' ? 0.45 : 0.3);
      if(musicOn && phase === 'setup'){
        showPopup('üéµ Flotten-Melodie an', 'hit', 900);
        menu.currentTime = 0;
        menu.play().catch(()=>{});
      } else {
        menu.pause();
        menu.currentTime = 0;
      }
    }

    function playMenuLoop(){
      const menu = document.getElementById('bg-menu');
      if(!menu) return;
      menu.volume = fxLevel === 'low' ? 0.18 : (fxLevel === 'high' ? 0.45 : 0.3);
      if(musicOn && phase === 'setup') menu.play().catch(()=>{});
      else menu.pause();
    }

    function startNew(diff='mittel'){
      difficulty = diff;
      phase = 'placement';
      const menu = document.getElementById('bg-menu');
      if(menu){ menu.pause(); menu.currentTime = 0; }
      document.getElementById('postGameRow')?.classList.add('hide');
      aiTargets = [];
      placementPlayer = 1;
      currentPlayer = 1;
      state.p1 = makePlayer('Spieler 1');
      state.p2 = makePlayer('Spieler 2');
      state.ai = makePlayer('KI');
      selShip = null;
      horizontal = true;

      document.getElementById('setup').classList.add('hide');
      document.getElementById('placement').classList.remove('hide');
      document.getElementById('boards').classList.remove('hide');
      document.getElementById('status').classList.remove('hide');

      renderShipList();
      renderBoards();
      setPlacementTitle();
      setStatus('Platziere deine Flotte.');
    }

    function setPlacementTitle(){
      const who = placementPlayer===1 ? 'Spieler 1' : (mode==='pvp' ? 'Spieler 2' : 'du');
      document.getElementById('placementTitle').textContent = `Platzierung: ${who} (${horizontal?'Horizontal':'Vertikal'})`;
    }

    function toggleOrientation(){
      horizontal = !horizontal;
      setPlacementTitle();
      playSfx('turn');
    }

    function renderShipList(){
      const host = document.getElementById('shipList');
      const me = getPlacementTarget();
      host.innerHTML='';
      for(const s of SHIPS){
        const d=document.createElement('div');
        d.className='ship-item';
        d.textContent=`${s.name} (${s.size})`;
        if(me.ships[s.id]) d.classList.add('done');
        if(selShip && selShip.id===s.id) d.classList.add('sel');
        d.onclick=()=>{ if(!me.ships[s.id]) { selShip=s; renderShipList(); }};
        host.appendChild(d);
      }
      document.getElementById('btnPlacementDone').disabled = Object.keys(me.ships).length !== SHIPS.length;
    }

    function getPlacementTarget(){
      if(placementPlayer===1) return state.p1;
      return mode==='pvp' ? state.p2 : state.p1;
    }

    function createBoard(el, ownerLabel){
      el.innerHTML='';
      el.appendChild(cell('','header'));
      for(let c=0;c<N;c++) el.appendChild(cell(String.fromCharCode(65+c),'header'));
      for(let r=0;r<N;r++){
        el.appendChild(cell(String(r+1),'header'));
        for(let c=0;c<N;c++){
          const d = cell('');
          d.dataset.r=r; d.dataset.c=c;
          d.classList.add('clickable');
          d.onclick=()=>onBoardCellClick(ownerLabel,r,c,d);
          el.appendChild(d);
        }
      }
    }

    function cell(t, cl=''){ const d=document.createElement('div'); d.className='cell'+(cl?(' '+cl):''); d.textContent=t; return d; }

    function renderBoards(){
      createBoard(document.getElementById('boardLeft'),'left');
      createBoard(document.getElementById('boardRight'),'right');
      document.getElementById('titleLeft').textContent = mode==='pvp' ? 'Spieler 1 Flotte' : 'Dein Feld';
      document.getElementById('titleRight').textContent = mode==='pvp' ? 'Spieler 2 Flotte' : 'Gegnerfeld';
      refreshBoardVisuals();
    }

    function refreshBoardVisuals(){
      const left = state.p1.board;
      const right = mode==='pvp' ? state.p2.board : state.ai.board;
      paintGrid('boardLeft', left, true, mode==='pvp' && phase==='battle' && currentPlayer===2);
      paintGrid('boardRight', right, mode==='pvp' || phase!=='battle', mode==='pvp' && phase==='battle' && currentPlayer===1);
    }

    function paintGrid(boardId, board, showShips, hideByTurn=false){
      const root = document.getElementById(boardId);
      root.querySelectorAll('.cell:not(.header)').forEach(c=>{
        const r=+c.dataset.r, col=+c.dataset.c;
        const v = board[r][col];
        c.classList.remove('ship-cell','ship-hidden','hit','miss','sunk');
        c.textContent=''; c.style.backgroundImage='';

        if(v.ship && showShips){
          c.classList.add('ship-cell');
          c.style.backgroundImage = `url(${sprites[v.ship.id]})`;
        }
        if(v.hit){ c.classList.add('hit'); c.textContent='‚úñ'; }
        if(v.miss){ c.classList.add('miss'); c.textContent='‚Ä¢'; }
      });
      if(hideByTurn){
        root.style.filter='brightness(.7)';
      } else root.style.filter='none';
    }

    function onBoardCellClick(side,r,c,cellEl){
      if(phase==='placement') return placementClick(side,r,c);
      if(phase==='battle') return battleClick(side,r,c,cellEl);
    }

    function placementClick(side,r,c){
      const target = placementPlayer===1 ? state.p1 : (mode==='pvp' ? state.p2 : state.p1);
      const validSide = (placementPlayer===1 && side==='left') || (placementPlayer===2 && side==='right') || (mode==='ai' && side==='left');
      if(!validSide || !selShip) return;
      if(!canPlace(target.board, r,c, selShip.size, horizontal)) return;
      const pos=[];
      for(let i=0;i<selShip.size;i++){
        const rr = horizontal ? r : r+i;
        const cc = horizontal ? c+i : c;
        target.board[rr][cc].ship = selShip;
        pos.push({r:rr,c:cc});
      }
      target.ships[selShip.id]={ ...selShip, cells:pos, hits:0, sunk:false };
      playSfx('place');
      selShip=null;
      renderShipList();
      refreshBoardVisuals();
    }

    function canPlace(board,r,c,size,h){
      const planned=[];
      for(let i=0;i<size;i++){
        const rr = h ? r : r+i;
        const cc = h ? c+i : c;
        if(rr<0||cc<0||rr>=N||cc>=N) return false;
        if(board[rr][cc].ship) return false;
        planned.push([rr,cc]);
      }
      // Regel: Schiffe d√ºrfen sich nicht ber√ºhren (auch nicht diagonal)
      for (const [rr,cc] of planned) {
        for (let dr=-1; dr<=1; dr++) {
          for (let dc=-1; dc<=1; dc++) {
            const nr = rr + dr, nc = cc + dc;
            if (nr<0 || nc<0 || nr>=N || nc>=N) continue;
            if (board[nr][nc].ship) return false;
          }
        }
      }
      return true;
    }

    function randomPlacement(){
      const t = placementPlayer===1 ? state.p1 : (mode==='pvp' ? state.p2 : state.p1);
      t.board = emptyBoard(); t.ships={};
      for(const s of SHIPS){
        let ok=false;
        while(!ok){
          const r=(Math.random()*N)|0, c=(Math.random()*N)|0, h=Math.random()<.5;
          if(canPlace(t.board,r,c,s.size,h)){
            const pos=[];
            for(let i=0;i<s.size;i++){
              const rr=h?r:r+i, cc=h?c+i:c;
              t.board[rr][cc].ship=s; pos.push({r:rr,c:cc});
            }
            t.ships[s.id]={...s,cells:pos,hits:0,sunk:false}; ok=true;
          }
        }
      }
      playSfx('place');
      renderShipList();
      refreshBoardVisuals();
    }

    function finishPlacement(){
      const t = getPlacementTarget();
      if(Object.keys(t.ships).length !== SHIPS.length) return;
      if(mode==='ai'){
        autoPlaceAI();
        beginBattle();
        return;
      }
      if(placementPlayer===1){
        placementPlayer=2;
        selShip=null;
        setPlacementTitle();
        renderShipList();
        setStatus('Spieler 2 √ºbernimmt und platziert jetzt.');
        playSfx('turn');
      } else {
        beginBattle();
      }
    }

    function autoPlaceAI(){
      const t = state.ai;
      t.board = emptyBoard(); t.ships={};
      for(const s of SHIPS){
        let ok=false;
        while(!ok){
          const r=(Math.random()*N)|0, c=(Math.random()*N)|0, h=Math.random()<.5;
          if(canPlace(t.board,r,c,s.size,h)){
            const pos=[];
            for(let i=0;i<s.size;i++){
              const rr=h?r:r+i, cc=h?c+i:c;
              t.board[rr][cc].ship=s; pos.push({r:rr,c:cc});
            }
            t.ships[s.id]={...s,cells:pos,hits:0,sunk:false}; ok=true;
          }
        }
      }
    }

    function beginBattle(){
      phase='battle';
      document.getElementById('placement').classList.add('hide');
      currentPlayer=1;
      setStatus(mode==='ai' ? 'Dein Zug auf dem rechten Feld.' : 'Spieler 1 beginnt auf dem rechten Feld.');
      playSfx('turn');
      refreshBoardVisuals();
    }

    function battleClick(side,r,c,el){
      const target = (currentPlayer===1)
        ? (mode==='ai' ? state.ai : state.p2)
        : state.p1;
      const attackSide = currentPlayer===1 ? 'right' : 'left';
      if(side!==attackSide) return;
      const shooter = currentPlayer===1 ? state.p1 : (mode==='ai' ? state.ai : state.p2);
      if(target.shots.has(key(r,c))) return;

      target.shots.add(key(r,c));
      shooter.totalShots++;
      const cell = target.board[r][c];
      const enemyActionOnMe = (mode==='ai' && currentPlayer===2);
      if(cell.ship){
        cell.hit=true; shooter.hits++;
        animate(el,'hitfx');
        playSfx('hit');
        const sh = target.ships[cell.ship.id];
        sh.hits++;
        if(sh.hits>=sh.size){
          sh.sunk=true;
          for(const p of sh.cells){ target.board[p.r][p.c].hit=true; }
          playSfx('sunk');
          const who = currentPlayer===1 ? 'Spieler 1' : (mode==='ai' ? 'KI' : 'Spieler 2');
          if (!enemyActionOnMe) setStatus(`${who} versenkt: ${sh.name}`);
          if (!enemyActionOnMe) showPopup(`üí• Versenkt! ${sh.name}`, 'sunk');
        } else {
          if (!enemyActionOnMe) setStatus('Treffer!');
          if (!enemyActionOnMe) showPopup('üéØ Treffer!', 'hit');
        }
      } else {
        cell.miss=true;
        animate(el,'missfx');
        playSfx('miss');
        if (!enemyActionOnMe) setStatus('Daneben.');
      }

      // Regel: genau ein Schuss pro Zug (f√ºr Spieler und KI)
      currentPlayer = currentPlayer===1 ? 2 : 1;
      refreshBoardVisuals();
      checkGameOver();
      if (phase==='battle' && mode==='ai' && currentPlayer===1) {
        setStatus('Dein Zug auf dem rechten Feld.');
      }
      if(phase==='battle' && mode==='ai' && currentPlayer===2){
        setTimeout(aiMove, 500);
        return;
      }
      playSfx('turn');
    }

    function enqueueAiNeighbors(r,c){
      const candidates = [[r-1,c],[r+1,c],[r,c-1],[r,c+1]];
      for(const [nr,nc] of candidates){
        if(nr<0||nc<0||nr>=N||nc>=N) continue;
        const k = key(nr,nc);
        if(state.p1.shots.has(k)) continue;
        if(aiTargets.some(t => t[0]===nr && t[1]===nc)) continue;
        aiTargets.push([nr,nc]);
      }
    }

    function aiMove(){
      if(phase!=='battle') return;
      let r,c;

      while(aiTargets.length){
        const t = aiTargets.shift();
        if(!state.p1.shots.has(key(t[0],t[1]))){
          [r,c] = t;
          break;
        }
      }

      if(r===undefined){
        const list=[];
        for(let i=0;i<N;i++) for(let j=0;j<N;j++) if(!state.p1.shots.has(key(i,j))) list.push([i,j]);
        if(difficulty==='schwer') list.sort((a,b)=>((b[0]+b[1])%2)-((a[0]+a[1])%2));
        [r,c] = list[(Math.random()*list.length)|0];
      }

      const willHit = !!state.p1.board[r][c].ship;
      const fakeEl = document.querySelector(`#boardLeft .cell[data-r='${r}'][data-c='${c}']`);
      battleClick('left',r,c,fakeEl);
      if(willHit) enqueueAiNeighbors(r,c);
    }

    function checkGameOver(){
      const aAll = Object.values((mode==='ai'?state.ai:state.p2).ships).every(s=>s.sunk);
      const p1All = Object.values(state.p1.ships).every(s=>s.sunk);
      if(aAll || p1All){
        phase='over';
        const win = aAll;
        setStatus(win ? 'üéâ Sieg!' : 'üí• Niederlage');
        document.getElementById('postGameRow')?.classList.remove('hide');
        showPopup(win ? 'üèÜ Sieg! Alle gegnerischen Schiffe versenkt.' : '‚ò†Ô∏è Niederlage! Deine Flotte wurde versenkt.', win ? 'win' : 'lose', 2600);
        playSfx(win?'win':'lose');
      }
    }

    function goToStart(){
      phase = 'setup';
      currentPlayer = 1;
      placementPlayer = 1;
      selShip = null;
      aiTargets = [];
      document.getElementById('postGameRow')?.classList.add('hide');
      document.getElementById('placement').classList.add('hide');
      document.getElementById('boards').classList.add('hide');
      document.getElementById('status').classList.add('hide');
      document.getElementById('setup').classList.remove('hide');
      if (musicOn) playMenuLoop();
    }

    function animate(cell, cls){
      const a=document.createElement('div'); a.className=`anim ${cls}`;
      cell.appendChild(a); setTimeout(()=>a.remove(),420);
    }

    let popupTimer = null;
    function showPopup(text, type='hit', ms=1200){
      const el = document.getElementById('popup');
      if(!el) return;
      if (fxLevel === 'low' && (type === 'hit' || type === 'sunk')) return;
      const scale = fxLevel === 'high' ? 1.2 : (fxLevel === 'low' ? 0.8 : 1);
      el.className = `popup ${type}`;
      el.textContent = text;
      void el.offsetWidth;
      el.classList.add('show');
      if(popupTimer) clearTimeout(popupTimer);
      popupTimer = setTimeout(()=> el.classList.remove('show'), Math.round(ms * scale));
    }

    function setStatus(t){ document.getElementById('status').textContent=t; }

    function initSprites(){
      for(const s of SHIPS) sprites[s.id]=makeShipSprite(24, s.hue);
    }

    function makeShipSprite(sz=24,h=190){
      const cv=document.createElement('canvas'); cv.width=sz; cv.height=sz;
      const x=cv.getContext('2d');
      x.imageSmoothingEnabled=false;
      x.fillStyle='#0d1e2f'; x.fillRect(0,0,sz,sz);
      x.fillStyle=`hsl(${h} 70% 45%)`; x.fillRect(3,5,sz-6,sz-10);
      x.fillStyle=`hsl(${h} 80% 62%)`; x.fillRect(5,7,sz-10,4);
      x.fillStyle='rgba(255,255,255,.3)'; x.fillRect(7,12,4,4); x.fillRect(sz-11,12,4,4);
      x.fillStyle='#06101a'; x.fillRect(2,4,2,sz-8); x.fillRect(sz-4,4,2,sz-8);
      return cv.toDataURL('image/png');
    }

    function playSfx(type){
      try {
        ensureAudio();
        const map = {
          hit: 'sfx-hit',
          miss: 'sfx-miss',
          sunk: 'sfx-sunk',
          win: 'sfx-win',
          lose: 'sfx-lose'
        };
        const id = map[type];
        if(id){
          const a = document.getElementById(id);
          if(a){
            a.volume = fxLevel === 'low' ? 0.2 : (fxLevel === 'high' ? 0.65 : 0.4);
            a.currentTime = 0;
            a.play().catch(()=>{});
            return;
          }
        }

        // Fallback-Synth, falls Audio-Dateien nicht verf√ºgbar sind
        const now = actx.currentTime;
        const tones = {
          place:[[300,.04,'triangle']],
          miss:[[180,.08,'sine']],
          hit:[[520,.05,'square'],[320,.08,'triangle']],
          sunk:[[440,.06,'square'],[280,.08,'sawtooth'],[180,.12,'triangle']],
          turn:[[660,.05,'sine']],
          win:[[520,.08,'square'],[660,.09,'square'],[880,.12,'triangle']],
          lose:[[300,.08,'sine'],[220,.1,'triangle'],[150,.14,'sine']]
        }[type] || [[300,.05,'sine']];

        const volume = fxLevel === 'low' ? 0.06 : (fxLevel === 'high' ? 0.18 : 0.12);
        let t = now;
        for(const [f,d,w] of tones){
          const o=actx.createOscillator(), g=actx.createGain();
          o.type=w; o.frequency.value=f;
          g.gain.setValueAtTime(.0001,t); g.gain.exponentialRampToValueAtTime(volume,t+.01); g.gain.exponentialRampToValueAtTime(.0001,t+d);
          o.connect(g); g.connect(actx.destination);
          o.start(t); o.stop(t+d+.01);
          t+=d*.75;
        }
      } catch(e){}
    }

    window.addEventListener('keydown', (e)=>{
      if(e.key.toLowerCase()==='r'){ toggleOrientation(); }
    });

    initSprites();
    setMode('ai');
  </script>
</body>
</html>